多機能雷センサー for Raspberry Pi Pico W概要Raspberry Pi Pico W を使用した、多機能な雷センサーです。雷の接近を検知して距離を測定するだけでなく、温湿度センサーによる環境モニタリング、Googleスプレッドシートへのデータ自動記録、LINEやSwitchBot APIと連携したスマートホーム機能、無線でのプログラム書き込み(OTA)など、多彩な機能を備えています。本体のLCDディスプレイとボタン操作により、ネットワーク経由で様々な機器を直感的にコントロールできます。主な機能雷検知機能 (AS3935センサー)雷雲までの距離を推定 (km単位)雷ではない人工的な電気ノイズ（ディスターバー）を識別周囲のノイズレベルを自動/手動で調整可能環境モニタリング (DHT20センサー)温度と湿度を測定データロギング測定した温湿度や雷の検知履歴をGoogleスプレッドシートに自動で記録スマートホーム連携SwitchBot API: 照明、テレビ、エアコンなどの家電を本体から操作LINE Messaging API: 雷を検知した際にLINEへ自動で通知ネットワーク機能NTPによる時刻同期: 正確な時刻を自動で取得・維持Wake on LAN (WoL): ネットワーク経由でPCの電源を投入OTA (Over-the-Air): Arduino IDEから無線でプログラムを書き込み可能オンデバイスUI20x4キャラクタLCDディスプレイに各種情報をリアルタイムで表示ボタン1つで全てのメニューを操作可能フルカラーLEDによるステータス表示必要なものハードウェアRaspberry Pi Pico W雷センサーモジュール: SparkFun AS3935 Lightning Detector など温湿度センサー: DFRobot DHT20LCDディスプレイ: I2C接続 20x4 キャラクタ液晶タクトスイッチ (プッシュボタン)フルカラーLED (アノードコモン or カソードコモン)抵抗 (LEDの電流制限用、プルアップ/ダウン用など適宜)ブレッドボードとジャンパーワイヤーソフトウェア & ライブラリArduino IDE (Raspberry Pi Picoボードパッケージをインストール済みであること)使用ライブラリ:WiFiHTTPClientWireLiquidCrystal (I2C版の場合は LiquidCrystal_I2C など適したものを使用)WiFiNTPDFRobot_DHT20SparkFun AS3935 Lightning DetectorArduinoJsonArduinoOTA※これらのライブラリはArduino IDEのライブラリマネージャからインストールできます。セットアップ手順1. ハードウェアの配線コード内の namespace Pins の定義に従って、各コンポーネントをRaspberry Pi Pico Wに接続します。コンポーネントPico W Pin (GP)備考I2CバスI2C SDAGP0AS3935, DHT20, LCDを接続I2C SCLGP1AS3935, DHT20, LCDを接続LCDディスプレイ※パラレル接続の場合の例LCD RSGP2LCD EGP3LCD D4GP4LCD D5GP5LCD D6GP6LCD D7GP7LCD バックライトGP14操作系ボタンGP15内部プルアップ有効センサー割り込みAS3935 IRQGP16フルカラーLEDLED 赤 (R)GP28アノードコモンの場合は逆論理LED 緑 (G)GP27LED 青 (B)GP262. Google Apps Script の設定提供されているGoogle Apps Scriptのコードを、新しいGoogleスプレッドシートのスクリプトエディタに貼り付けます。スクリプトを「ウェブアプリ」としてデプロイします。アクセスできるユーザー: 「全員」に設定してください。デプロイ後に表示される ウェブアプリURL をコピーします。3. Arduinoコードの設定スケッチ pico_w_lightning_sensor_v5.6.ino を開き、★★★ 設定項目 ★★★ のセクションを自分の環境に合わせて編集します。GAS_URL: 手順2でコピーしたウェブアプリのURLを貼り付けます。wifiCredentials: 接続するWi-FiのSSIDとパスワードを複数設定できます。MAC_DESKTOP, MAC_SERVER: Wake on LANで使用するPCのMACアドレスを設定します。SWITCHBOT_TOKEN, SWITCHBOT_SECRET: SwitchBotのAPIトークンとシークレットキーを設定します。DEVICE_ID_*: 操作したいSwitchBotデバイスのIDを設定します。LINE_CHANNEL_ACCESS_TOKEN, LINE_USER_ID: LINE通知用のアクセストークンとユーザーIDを設定します。4. 書き込みと実行Arduino IDEでボードを「Raspberry Pi Pico W」に設定します。シリアルポートを選択し、プログラムを書き込みます。書き込みが完了すると、デバイスが起動し、LCDに初期メッセージが表示された後、Wi-Fiへの接続を開始します。操作方法基本操作短く押す: メニュー画面で項目を下に移動します。長く押す:メイン画面: メニュー画面に移行します。メニュー画面: 選択中の項目を実行します。履歴画面など: メイン画面に戻ります。メイン画面1行目: 現在日時 (NTPで同期後)2行目: 温度 (T) と湿度 (H)3行目: 最後に検知したイベントの時刻4行目: イベントの種類 (雷、ノイズ、ディスターバー) と雷の場合は距離メニュー項目Lightning Log: 直近3件のイベント履歴（雷、ノイズ等）を表示します。Device Control: SwitchBotで登録した家電を操作するメニューに入ります。Wake on LAN: 登録したPCにWoLパケットを送信します。Backlight Mode: LCDバックライトの常時ON/自動OFFを切り替えます。RGB Illumination: 本体下部のRGB LEDのイルミネーションをON/OFFします。Measure Dist: (子機連携用) 超音波センサーの距離を測定します。Resync Time: NTPサーバーと時刻を再同期します。Show IP Address: 本体のIPアドレスを5秒間表示します。Get SwitchBot IDs: SwitchBotデバイスの一覧をシリアルモニタに出力します。Send LINE Test: LINEにテスト通知を送信します。Log Data Manually: 手動で現在の温湿度をスプレッドシートに記録します。Reboot: 本体を再起動します。Sensor Diag: 雷センサーの内部レジスタ値を表示し、状態を診断します。Calibrate Sensor: 雷センサーのアンテナのキャリブレーションを実行します。カスタマイズと拡張このプロジェクトは、機能を追加したり、設定を変更したりしやすいように設計されています。以下に主なカスタマイズ方法を説明します。新しいSwitchBotデバイスの追加pico_w_lightning_sensor_v5.6.ino を開きます。★★★ 設定項目 ★★★ セクションで、新しいデバイスID用の定数を宣言します。const char* DEVICE_ID_NEW_DEVICE = "YOUR_NEW_DEVICE_ID";
namespace Menu内の applianceMenu に、新しいデバイスの項目を追加します。const MenuItem applianceMenu[] = {
    // ... 既存のデバイス ...
    {"7. New Device", enterDeviceControl}, // 新しいデバイスを追加
    {"8. Back", [](){ changeMode(State::MENU); }}
};
新しいデバイス用の操作メニュー（例: newDeviceControlMenu）を作成します。lightControlMenu などを参考に、コマンドを定義してください。applianceControlMenus 配列と applianceControlMenuCounts 配列に、新しく作成したメニューを追加します。新しいメニュー項目の追加メインメニューに独自の機能を追加することも簡単です。namespace Menu内の mainMenu 配列に新しい項目を追加します。const MenuItem mainMenu[] = {
    // ... 既存のメニュー ...
    {"15. New Function", [](){ performMenuAction(YourNewFunction, true); }}
};
YourNewFunction という名前の新しい関数を、例えば namespace Utils などに作成します。この関数内で実行したい処理を記述してください。performMenuAction の2番目の引数が true の場合、実行後にメイン画面に戻ります。 false の場合は現在のメニューに留まります。センサー感度の調整雷センサーの感度は、環境によって調整が必要な場合があります。★★★ 設定項目 ★★★ セクションにある以下の定数の値を変更します。LIGHTNING_WATCHDOG_THRESHOLD: 雷だと判断する信号の強さの閾値です。数値を下げると感度が上がります。LIGHTNING_SPIKE_REJECTION: 電気的スパイクノイズの除去レベルです。ノイズが多い環境では数値を上げます。INITIAL_NOISE_LEVEL: センサーが無視する環境ノイズの初期レベルです。コードの構造このプログラムは、機能を明確に分離するために namespace を使用して構成されています。State: 全てのグローバル変数と状態を管理します。Pins: ピン配置の定義を集約します。Crypto: SwitchBot APIに必要な暗号化処理を行います。Menu: メニューの定義と画面遷移を管理します。Utils: 汎用的な補助関数（LED制御など）を含みます。Display: LCDへの描画処理全般を担当します。Network: Wi-Fi接続、API通信、OTAなど全てのネットワーク処理を担当します。Sensors: AS3935とDHT20センサーの読み取りと処理を担当します。Input: ボタン入力のチャタリング防止と長押し・短押しの判定を行います。バージョン履歴v5.6 (2025/09/09): ディスターバー(人工ノイズ)検知時の処理を追加。v5.5 (2025/09/10): スプレッドシート記録の安定性を向上（URLエンコード、リダイレクト対応）。v5.4 (2025/09/10): 診断機能のバグを修正。(それ以前のバージョン...)ライセンスこのプロジェクトは MIT License の下で公開されています。
