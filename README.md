# 多機能雷センサー for Raspberry Pi Pico W (詳細版)

## 概要

このプロジェクトは、安価で高性能なマイクロコントローラ「Raspberry Pi Pico W」を心臓部に、雷の接近や周辺環境の変化をリアルタイムで捉える高機能センサーを製作することを目的としています。

単に雷を検知するだけでなく、その雷がどれくらいの距離で発生したかを推定し、同時に温度と湿度を常時監視します。収集したデータは、Wi-Fiを経由してGoogleスプレッドシートに自動的に記録され、長期的な環境データの分析に役立ちます。

さらに、スマートホームプラットフォームとの連携も大きな特徴です。雷を検知した際にはLINEで即座に通知を受け取ったり、このデバイスのボタン操作一つでSwitchBotに接続された照明やエアコン、テレビなどの家電を遠隔操作したりすることが可能です。これにより、DIY電子工作の楽しさと、日常生活における実用性・安全性の向上を両立させます。

## インストール

### 1. 必要なもの（ハードウェア）
各コンポーネントの役割を理解することで、組み立てがスムーズになります。

   * **Raspberry Pi Pico W:** プロジェクト全体の頭脳。Wi-Fi機能を内蔵しており、ネットワーク通信を担います。
   * **雷センサーモジュール (SparkFun AS3935):** 雷が発する特有の電波を捉え、雷雲までのおおよその距離を算出します。人工的な電気ノイズと雷を区別する高度な機能を持ちます。
   * **温湿度センサー (DFRobot DHT20):** 周囲の温度と湿度を測定します。環境のモニタリングに不可欠です。
   * **LCDディスプレイ (I2C接続 20x4):** 測定データやメニュー、ステータスを表示する情報画面です。I2C接続タイプは少ない配線で済むのが利点です。
   * **その他:**
     - **タクトスイッチ:** ユーザーがメニューを操作するための入力装置です。
     - **フルカラーLED:** デバイスの状態（Wi-Fi接続中、雷検知など）を色で直感的に知らせます。
     - **抵抗、ブレッドボード、ジャンパーワイヤー:** 各部品を電気的に正しく接続するための基本的な電子工作部品です。

### 2. 必要なもの（ソフトウェア・ライブラリ）
Arduino IDEをプログラミング環境として使用します。

   * **Arduino IDE:** Raspberry Pi Picoボードパッケージを事前にインストールしておいてください。
   * **必要なライブラリ：** IDEのライブラリマネージャから以下のものをインストールします。
     - `WiFi`, `WiFiServer`, `WiFiClientSecure`, `HTTPClient`, `Wire`: Pico Wの基本的なネットワーク機能とI2C通信に必要です。
     - `LiquidCrystal_I2C`: I2C接続のLCDを簡単に制御するために使用します。
     - `WiFiNTP`: 正確な時刻をインターネット経由で取得します。
     - `DFRobot_DHT20`: 温湿度センサーからのデータ読み取りに使用します。
     - `SparkFun AS3935 Lightning Detector`: 雷センサーを制御するための専用ライブラリです。
     - `ArduinoJson`: 外部APIとの通信データ（JSON形式）を扱うために重要です。
     - `ArduinoOTA`: Wi-Fi経由でプログラムを書き換える（無線アップデート）ために使用します。

### 3. 設定
ハードウェアとソフトウェアを連携させるための重要なステップです。

   * **ハードウェアの配線:** スケッチ（プログラムコード）内の`namespace Pins`セクションに、どの部品をPico Wのどのピン（GP0, GP1など）に接続するかが定義されています。この定義通りに、ジャンパーワイヤーを使って正確に配線してください。特にI2Cデバイス（雷センサー、温湿度センサー、LCD）は、すべて同じSDA/SCLピンに並列で接続します。

   * **Google Apps Script:**
     1. Googleスプレッドシートを新規作成し、「拡張機能」メニューからApps Scriptを開きます。
     2. 提供されているスクリプトコードを貼り付け、プロジェクトを保存します。
     3. スクリプトを「ウェブアプリ」としてデプロイします。この際、アクセス権限を「全員」に設定しないと、Pico Wからデータを受け取れないため注意してください。
     4. デプロイ後に生成される「ウェブアプリURL」を必ずコピーしておきます。

   * **Arduinoコード:**
     1. `pico_w_lightning_sensor_v5.6.ino` ファイルをArduino IDEで開きます。
     2. `★★★ 設定項目 ★★★`とコメントされているセクションを見つけ、以下の項目を自分の環境に合わせて書き換えます。
        - `GAS_URL`: 先ほどコピーしたGoogleのウェブアプリURLを貼り付けます。
        - `wifiCredentials`: 自宅のWi-FiのSSID（名前）とパスワードを入力します。
        - `SWITCHBOT_TOKEN`, `LINE_USER_ID`など: SwitchBotやLINE連携機能を使用する場合、各サービスで取得したAPIキーやトークンを設定します。

## 使い方

### 1. プログラムの書き込み
   * Arduino IDEで、ツールメニューからボードとして「Raspberry Pi Pico W」を選択します。
   * PCとPico WをUSBケーブルで接続します。初めて書き込む際は、Pico Wの「BOOTSEL」ボタンを押しながら接続し、PCに認識させてください。
   * IDEの書き込みボタン（→）をクリックし、コンパイルと書き込みが完了するのを待ちます。

### 2. 操作方法
書き込みが完了すると、デバイスは自動的に再起動し、動作を開始します。

   * **基本操作:**
     - **短く押す (タップ):** メニュー画面で、選択カーソルを次の項目へ移動させます。
     - **長く押す (1秒以上):**
       - メイン画面で：メニュー画面へ入ります。
       - メニュー画面で：選択中の項目を決定・実行します。
       - 各機能画面で：メイン画面へ戻ります。

   * **画面の見方:**
     - **メイン画面:** 起動後に表示される基本画面です。現在の日時、温度、湿度、そして最後に検知した雷イベント（距離またはノイズ）が表示され、一目で状況がわかります。
     - **メニュー画面:** ボタン長押しでアクセスします。ここから「デバイス操作」「時刻の再同期」「IPアドレスの表示」など、本機のすべての機能を選択できます。

## ライセンス

このプロジェクトは、[ライセンス名] ライセンスの下でライセンスされています。

## 更新履歴

* 2025/09/10: [v5.6 - ディスターバー検知機能の追加と安定性の向上]
